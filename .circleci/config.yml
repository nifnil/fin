version: 2.1

jobs:
  lint:
    docker:
      - image: cimg/node:24.12.0

    steps:
      - checkout
      - run:
          name: "Install dependencies"
          command: "pnpm install"
      - run:
          name: "Run ESLint"
          command: "pnpm lint"

  code-review:
    docker:
      - image: cimg/python:3.11

    steps:
      - checkout
      - run:
          name: Verify required environment variables
          command: |
            if [ -z "$GITHUB_TOKEN" ] || \
               [ -z "$CLAUDE_MODEL" ] || \
               [ -z "$ANTHROPIC_API_KEY" ] || \
               [ -z "$CIRCLE_PULL_REQUEST" ] || \
               [ -z "$CIRCLE_PROJECT_USERNAME" ] || \
               [ -z "$CIRCLE_PROJECT_REPONAME" ]; then
              echo "Required environment variables not set"
              exit 1
            fi
      - run:
          name: Install dependencies
          command: |
            pip install -r scripts/requirements.txt
      
      - run:
          name: Run Claude Code Review
          command: |
            python scripts/code_reviewer.py


workflows:
  pr-review:
    jobs:
      - lint
      - code-review:
          requires:
            - lint
          filters:
            branches:
              ignore:
                - main